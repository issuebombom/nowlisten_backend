# TODOLIST

## NestJS 기본 설정

- Local 환경 변수 설정
- Winston 로깅 설정
- Swagger 설정
- CORS 설정
- Exception 필터 설정
- PostgreSQL Docker 설정 및 연결
- Class-validator 설정
- DB 쿼리 로거 커스텀 설정

## User

### 내 프로필 관리

- 내 프로필 조회
- 내 프로필 수정
- 유저 삭제 (비밀번호 재검증 필요)

### 비밀번호 재설정 (Forgot Password)

- 비밀번호 찾기 시 이메일로 새 비밀번호 설정 링크 전달
  - 링크에 암호화된 토큰 포함
  - 토큰은 메모리(Redis)에 `password-reset:토큰 - userId` 형태로 5분 TTL로 보관
- 프론트엔드에서 새 비밀번호 설정 페이지 제공 (유효성 검사 적용)
- 제출 시 토큰과 새 비밀번호를 백엔드로 전송

### 토큰 유효성 검증 (Verify Token)

- 비밀번호 재설정 링크 만료 시 만료 페이지로 안내하는 API 필요

### 비밀번호 재설정 (Reset Password)

- 프론트엔드로부터 토큰과 새 비밀번호를 POST로 수신
- 토큰 유효성 확인 (메모리 존재 여부 및 userId 획득)
- 새 비밀번호 저장 (argon2 해싱)
- 메모리에서 토큰 삭제

### 회원 탈퇴 (Delete User)

- 회원 탈퇴 시 비밀번호 인증 후 처리
- 소셜 로그인 유저의 경우 비밀번호가 null일 수 있음
  - 비밀번호 재설정 유도 (이메일 발송 -> 새 비밀번호 설정 페이지 리다이렉트)
  - 새 비밀번호 설정 클릭 시 백엔드 API에서 링크 검증 후 처리

## Email

### 이메일 전송 서비스

- AWS SES 등록 (도메인 구매 필요)
- Nodemailer 적용

## Auth (인증/인가)

### 회원가입 (Signup)

- 이메일 인증 방식 적용
  - 회원가입 폼에서 인증번호 발송 버튼 클릭 시
    - 이메일 중복 검증
    - 6자리 임시 코드 생성 (대문자 + 숫자)
    - Redis에 `user-signup:이메일 = 임시코드` 형태로 5분 TTL로 저장
    - 이메일로 인증 코드 발송
  - 임시 코드 확인 후 "인증 확인" 클릭 시
    - Redis에서 임시 코드 확인
    - 일치 여부 및 TTL 초과 여부 확인 후 응답
- 요청 바디 획득
- 비밀번호 해싱
- DB 저장
- 응답 DTO 반환

### 로그인 (Login)

- 요청 바디 획득
- 유저 조회 (DB)
- 유저 미존재 시 에러 처리
- 비밀번호 검증
- 비밀번호 불일치 시 에러 처리
- JWT Access, Refresh 토큰 생성
- Refresh 토큰 정보 DB 저장
- Access, Refresh 토큰 반환

### 로그아웃 (Logout)

- Refresh 토큰 획득 (Bearer)
- Guard를 통한 인증
- JTI(JWT ID) 획득
- `refresh_token` 테이블에서 해당 토큰 삭제

### 모든 기기 로그아웃 (Logout All Devices)

- Access 토큰 획득 (Bearer)
- Guard를 통한 인증
- userId 획득
- `refresh_token` 테이블에서 해당 유저 기반의 모든 토큰 삭제

### 토큰 갱신 (Refresh)

- Refresh 토큰 획득 (Bearer)
- Guard를 통한 인증
- userId 획득
- 새 Access 토큰 생성 및 반환

### 소셜 로그인 (Social Login)

- Google OAuth 2.0 설정
- 임시 토큰 발급을 통한 안전한 JWT 전달

## AuthGuard

- Guard 및 Strategy 구현
- Exception Filtering (미존재, 만료, 유효하지 않음 등)
- `req.user`를 통한 JWT 페이로드 전달

## RefreshToken 관리

- 만료된 토큰 정기 삭제 (Crontab 활용)
- JTI 기반 Refresh 토큰 삭제 기능
- 유저 기반 Refresh 토큰 삭제 기능 (모든 디바이스 로그아웃)

## Workspace

### 워크스페이스 관리

- 워크스페이스 생성
- 워크스페이스 조회
  - 유저 ID로 워크스페이스 멤버 조회 (status: active)
  - 비활성화된 워크스페이스(isActive: false)는 제외 (단, OWNER는 노출)
  - 최근 생성일 기준으로 정렬 (쿼리에서 처리, 유저 선택권 없음)
- 워크스페이스 업데이트
  - 워크스페이스 이름 변경
  - 워크스페이스 Slug 변경 (서브도메인 활용 예정, 유일성 보장 필요 -> 인덱스 추가 고려)
  - 워크스페이스 활성화/비활성화 변경
- 워크스페이스 삭제

### 워크스페이스 초대

- **Check**: 프론트엔드에서 로그인/회원가입 후 리다이렉트될 파라미터 지정 공간 필요 (예: 쿼리 스트링)
- **프론트엔드**: 이미 초대되었거나 참여 중인 이메일에 대한 유효성 검사 필요
- 초대 대상 이메일, 워크스페이스 ID, 초대한 유저 ID 수신
- 초대 자격 확인 (매니저 또는 오너 권한)
- 초대하는 유저가 활성 상태인지 확인
- 중복 초대 여부 확인 (초대 대기, 완료, 거절 상태 등)
- 해당 워크스페이스가 활성 상태인지 확인
- `invitation` 테이블 생성: 대상 이메일, 워크스페이스 ID, 상태, 초대 날짜, 응답 날짜 (수락/거절), 초대한 유저 ID, 초대 코드 (토큰), 만료 기간
- 이메일 발송 (참여 링크 포함 -> 프론트엔드 참여 링크) -> 7일 동안 유효
- **프론트엔드**: 링크 접속 시 (`/join/초대코드`로 이동, 토큰 포함)
  - 초대 토큰 유효성 검증 요청 -> 백엔드 (DB)
  - 로그인 여부 확인 (쿠키 JWT)
  - 로그인 안 되어 있을 시 로그인 페이지로 이동
    - 로컬 로그인: JWT 수신 후 `join` 페이지로 이동 (`join/토큰`으로 리다이렉트)
    - 소셜 로그인: 검증 후 JWT 수신 및 `join` 페이지로 이동
  - 회원가입 버튼 클릭 시
    - 회원가입 페이지 이동 (쿼리 스트링에 리다이렉트 페이지 + 토큰 정보 포함)
    - 회원가입 후 로그인 페이지 리다이렉트 -> 로그인 후 `join` 페이지 이동
  - 로그인 되어 있을 시 `join` 페이지로 이동
    - (워크스페이스 이름, 초대한 사람, 참여자 목록 등 노출) 초대된 워크스페이스에서 사용할 닉네임 작성 후 참여 버튼 클릭
- `join` 페이지 접속 시
  - 보여줄 초대 관련 정보 전달 (워크스페이스 이름, 초대한 사람 이름 등)
  - **백엔드**: 닉네임 작성 후 참여 버튼 클릭 시
    - **프론트엔드**: 닉네임 작성 `input` 태그 필요 -> 바디로 수신
    - JWT 검증, 토큰 검증 (만료, 이메일 일치)
    - 트랜잭션 처리
      - `invitation` 업데이트
      - 워크스페이스 멤버 생성 (역할: `guest`)

### 초대 링크 관리

- 초대 링크의 TTL을 7일로 부여 (`DB expiredAt`으로 관리)

### 초대 취소 (링크 비활성화)

- **프론트엔드**: 생성한 초대 링크 목록 제공 및 '초대 취소' 버튼 클릭 시 동작
- 초대 토큰 기반 조회
- 요청자가 초대자인지 확인
- `status`를 `canceled`로 수정

### 워크스페이스 멤버 관리

- 워크스페이스 멤버 조회
  - 요청자가 워크스페이스 멤버에 속하는지 확인
  - 20명씩 조회 (Keyset Pagination 적용)
- 멤버 권한 변경 (상실)
  - 요청자가 멤버의 권한을 변경할 권한이 있는지 확인
  - 대상 멤버가 워크스페이스 멤버인지 확인
  - 본인 스스로 역할 변경 불가
  - 실행자가 대상보다 등급이 높은지 확인
  - 권한 변경 적용
  - _참고_: 권한 상실 전 관련 생성 데이터 삭제 여부 (예: 초대 권한 상실)
    -> 초대받은 사람이 초대장에 접근 시 초대한 사람의 권한 유무를 확인하므로 괜찮음
- 멤버 활성화/비활성화 설정
  - 요청자가 멤버 상태 변경 권한이 있는지 확인
  - 대상 멤버가 워크스페이스 멤버인지 확인
  - 본인 스스로 역할 변경 불가
  - 실행자가 대상보다 등급이 높은지 확인
  - 상태 변경 적용

- 멤버 탈퇴 또는 강퇴
  - 요청자가 멤버를 제외할 권한이 있는지 확인
  - 대상 멤버가 워크스페이스 멤버인지 확인
  - 본인 스스로 탈퇴 가능 (탈퇴 권한이 있는 경우)
  - 실행자가 대상보다 등급이 높은지 확인
  - 제외 대상 멤버의 워크스페이스 초대 링크 삭제 (CASCADE 동작 확인 필요)

## [참고] Next.js (프론트엔드)와 Nest.js (백엔드)의 Auth 역할 분리

- Next.js는 클라이언트 영역과 별개로 서버 영역이 존재
- 로그인 시 백엔드는 Access, Refresh 토큰을 프론트엔드에 전달
- Next.js 서버는 이를 기반으로 세션 쿠키 생성 (Access, Refresh, 유저 정보 포함)
- Access 토큰 만료 시 Refresh 토큰을 백엔드에 전송하여 새 Access 토큰 재발급
- Next.js 서버는 세션 쿠키의 Access 토큰 갱신
- 단일 기기 로그아웃 시
  - Next.js 서버는 해당 세션 쿠키 삭제
  - Refresh 토큰을 백엔드에 전달하여 `refresh_token` 테이블에서 삭제
- 전체 기기 로그아웃 시
  - Next.js 서버는 해당 세션 쿠키 삭제
  - Access 토큰을 백엔드에 전달
  - 백엔드는 Access 토큰에서 유저 정보를 획득, 해당 유저와 연결된 모든 Refresh 토큰 삭제 (이때 Access 토큰이 유효할 경우 잠시 로그인 상태 유지 가능)

## 기타 (General)

- **TODO**: Cron 스케줄러가 멀티 인스턴스 환경일 경우 중복 처리됨에 따른 고려 필요 -> 큐 시스템 도입 검토
- **TODO**: 로그인 로깅 (Middleware를 통해 User-Agent 및 IP 정보 추적 가능하게 구현)
- 데이터베이스 성능 측정
